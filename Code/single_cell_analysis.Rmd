---
title: "Single Cell Analysis"
author: "Thomas & Annalisa"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
---

------------------------------------------------------------------------

This document contains the single cell analysis performed in the paper by [*Jung, SH., Hwang, BH., Shin, S. et al. Spatiotemporal dynamics of macrophage heterogeneity and a potential function of Trem2hi macrophages in infarcted hearts. Nat Commun 13, 4580 (2022)*](https://doi.org/10.1038/s41467-022-32284-2).

### Load necessary libraries

```{r setup, include=FALSE}
setwd("~/Documents/Repo_Git/Interpretation_of_a_spatial_omics_dataset/data")
```


```{r load_packages, message=FALSE, warning=FALSE}
library(Seurat)
library(SingleR)
library(SeuratWrappers)
library(monocle3)
library(reticulate)
library(Matrix)
library(ggplot2)
library(cowplot)
library(magrittr)
library(patchwork)
library(dplyr)
```

```{r}
options(future.globals.maxSize = 300000 * 1024^2)
```

## Load and process expression data

To perform the analysis, we will load the data downloaded from [GSE163129](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE163129).

```{r}
Control.data <- Read10X_h5("../data/GSE163129_RAW/GSM4972357_Steady-state_filtered_feature_bc_matrix.h5")
MI_1D.data <- Read10X_h5("../data/GSE163129_RAW/GSM4972358_Day1_post-MI_filtered_feature_bc_matrix.h5")
MI_3D.data <- Read10X_h5("../data/GSE163129_RAW/GSM4972359_Day3_post-MI_filtered_feature_bc_matrix.h5")
MI_5D.data <- Read10X_h5("../data/GSE163129_RAW/GSM4972360_Day5_post-MI_filtered_feature_bc_matrix.h5")
MI_7D.data <- Read10X_h5("../data/GSE163129_RAW/GSM4972361_Day7_post-MI_filtered_feature_bc_matrix.h5")
```

```{r}
MI.control <- CreateSeuratObject(Control.data, project = "MI_CTR", min.cells = 10)
MI.1D <- CreateSeuratObject(MI_1D.data, project = "MI_1D", min.cells = 10)
MI.3D <- CreateSeuratObject(MI_3D.data, project = "MI_3D", min.cells = 10)
MI.5D <- CreateSeuratObject(MI_5D.data, project = "MI_5D", min.cells = 10)
MI.7D <- CreateSeuratObject(MI_7D.data, project = "MI_7D", min.cells = 10)
```

```{r}
MI.control[['percent.mito']] <- PercentageFeatureSet(MI.control, pattern = "^mt-")
MI.1D[['percent.mito']] <- PercentageFeatureSet(MI.1D, pattern = "^mt-")
MI.3D[['percent.mito']] <- PercentageFeatureSet(MI.3D, pattern = "^mt-")
MI.5D[['percent.mito']] <- PercentageFeatureSet(MI.5D, pattern = "^mt-")
MI.7D[['percent.mito']] <- PercentageFeatureSet(MI.7D, pattern = "^mt-")
```

```{r FeatureScatter_control}
scatter_control_1 <- FeatureScatter(MI.control, "nCount_RNA", "nFeature_RNA")
scatter_control_2 <- FeatureScatter(MI.control, "nCount_RNA", "percent.mito")
scatter_control_1 + scatter_control_2
```

```{r FeatureScatter_day1}
scatter_1D_1 <- FeatureScatter(MI.1D, "nCount_RNA", "nFeature_RNA")
scatter_1D_2 <- FeatureScatter(MI.1D, "nCount_RNA", "percent.mito")
scatter_1D_1 + scatter_1D_2
```

```{r FeatureScatter_Day3}
scatter_3D_1 <- FeatureScatter(MI.3D, "nCount_RNA", "nFeature_RNA")
scatter_3D_2 <- FeatureScatter(MI.3D, "nCount_RNA", "percent.mito")
scatter_3D_1 + scatter_3D_2
```

```{r FeatureScatter_Day5}
scatter_5D_1 <- FeatureScatter(MI.5D, "nCount_RNA", "nFeature_RNA")
scatter_5D_2 <- FeatureScatter(MI.5D, "nCount_RNA", "percent.mito")
scatter_5D_1 + scatter_5D_2
```

```{r FeatureScatter_Day7}
scatter_7D_1 <- FeatureScatter(MI.7D, "nCount_RNA", "nFeature_RNA")
scatter_7D_2 <- FeatureScatter(MI.7D, "nCount_RNA", "percent.mito")
scatter_7D_1 + scatter_7D_2
```

```{r, fig.cap="Violin plot control"}
VlnPlot(MI.control, features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3)
```
```{r, fig.cap="Violin plot Day 1"}
VlnPlot(MI.1D, features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3)
```

```{r, fig.cap="Violin plot Day 3"}
VlnPlot(MI.3D, features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3)
```

```{r, fig.cap="Violin plot Day 5"}
VlnPlot(MI.5D, features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3)
```

```{r, fig.cap="Violin plot Day 7"}
VlnPlot(MI.7D, features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3)
```


## Apply filter criteria

```{r quantile_control}
quantile(MI.control$nFeature_RNA, probs = c(0.02,0.98))
```

```{r quantile_day1}
quantile(MI.1D$nFeature_RNA, probs = c(0.02,0.98))
```

```{r quantile_day3}
quantile(MI.3D$nFeature_RNA, probs = c(0.02,0.98))
```

```{r quantile_day5}
quantile(MI.5D$nFeature_RNA, probs = c(0.02,0.98))
```

```{r quantile_day7}
quantile(MI.7D$nFeature_RNA, probs = c(0.02,0.98))
```


```{r subsetting}
MI.control <- subset(x = MI.control, subset = nFeature_RNA > 371 & nFeature_RNA < 5061 & percent.mito < 10)
MI.1D <- subset(x = MI.1D, subset = nFeature_RNA > 350 & nFeature_RNA < 5199 & percent.mito < 10)
MI.3D <- subset(x = MI.3D, subset = nFeature_RNA > 407 & nFeature_RNA < 7825 & percent.mito < 10)
MI.5D <- subset(x = MI.5D, subset = nFeature_RNA > 493 & nFeature_RNA < 6741 & percent.mito < 10)
MI.7D <- subset(x = MI.7D, subset = nFeature_RNA > 410 & nFeature_RNA < 6132 & percent.mito < 10)

```

## MergeData

```{r}
experiment.aggregate <- merge(x = MI.control, y = c(MI.1D,MI.3D,MI.5D,MI.7D))

samplename = experiment.aggregate@meta.data$orig.ident
table(samplename)
```

```{r}
batchorder = rep("MI",length(samplename))
batchorder[samplename %in% c("MI_CTR")] = "1"
batchorder[samplename %in% c("MI_1D")] = "2"
batchorder[samplename %in% c("MI_3D")] = "3"
batchorder[samplename %in% c("MI_5D")] = "4"
batchorder[samplename %in% c("MI_7D")] = "5"
names(batchorder) = colnames(experiment.aggregate)

batchid = rep("MI",length(samplename))
batchid[samplename %in% c("MI_CTR")] = "MI_CTR"
batchid[samplename %in% c("MI_1D")] = "MI_1D"
batchid[samplename %in% c("MI_3D")] = "MI_3D"
batchid[samplename %in% c("MI_5D")] = "MI_5D"
batchid[samplename %in% c("MI_7D")] = "MI_7D"
names(batchid) = colnames(experiment.aggregate)

experiment.aggregate <- AddMetaData(object = experiment.aggregate, metadata = batchorder, col.name = "batchorder")
table(experiment.aggregate@meta.data$batchorder)
```

```{r}
experiment.aggregate <- AddMetaData(object = experiment.aggregate, metadata = batchid, col.name = "batchid")
table(experiment.aggregate@meta.data$batchid)
```

## Perform integration

```{r}
MI.list <- SplitObject(experiment.aggregate, split.by = "batchid")

for (i in 1:length(MI.list)) {
  MI.list[[i]] <- NormalizeData(MI.list[[i]], verbose = FALSE)
  MI.list[[i]] <- FindVariableFeatures(MI.list[[i]], selection.method = "vst", 
                                             nfeatures = 2000, verbose = FALSE)
}

MI.anchors <- FindIntegrationAnchors(object.list = MI.list, dims = 1:30)
MI.integrated <- IntegrateData(anchorset = MI.anchors, dims = 1:30)
all.genes <- rownames(MI.integrated)
MI.integrated <- ScaleData(MI.integrated, features = all.genes, verbose = FALSE)
MI.integrated <- RunPCA(MI.integrated, verbose = FALSE)
ElbowPlot(object = MI.integrated, ndims = 50)
use.pcs = 1:40
MI.integrated <- RunUMAP(MI.integrated, reduction = "pca", dims = use.pcs)
MI.integrated <- FindNeighbors(object = MI.integrated, reduction = "pca", dims = use.pcs)
MI.integrated <- FindClusters(object = MI.integrated, resolution = seq(0.5,2,0.1))
sapply(grep("^integrated_snn_res",colnames(MI.integrated@meta.data),value = TRUE), function(x) length(unique(MI.integrated@meta.data[,x])))
DimPlot(object = MI.integrated, reduction = 'umap', group.by = "integrated_snn_res.1.4", pt.size=0.5, label = TRUE, repel = TRUE) + NoLegend()
DimPlot(object = MI.integrated, reduction = 'umap', group.by = "batchid", pt.size=0.5)
DimPlot(object = MI.integrated, reduction = 'umap', group.by = "orig.ident", split.by = "batchid",  pt.size=0.5, ncol = 3) + NoLegend()
MI.integrated <- SetIdent(MI.integrated, value = 'integrated_snn_res.1.4')

DefaultAssay(MI.integrated) <- "RNA"
MI.integrated <- NormalizeData(MI.integrated, verbose = FALSE)
all.genes <- rownames(MI.integrated)
MI.integrated <- ScaleData(MI.integrated, features = all.genes, verbose = FALSE)
markers_all_RNA <- FindAllMarkers(object = MI.integrated, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, test.use = "LR")
write.csv(markers_all_RNA, file = "MI_preprocessing_cluster_allmarker_Genes_RNA_RES14.csv")
table(MI.integrated@meta.data$integrated_snn_res.1.4,MI.integrated@meta.data$batchid)

```

## SingleR

```{r}
mrsd.se <- ImmGenData()
MI.integrated.se <- as.SingleCellExperiment(MI.integrated, assay = "RNA")
mrsd.common <- intersect(rownames(MI.integrated.se), rownames(mrsd.se))
mrsd.se <- mrsd.se[mrsd.common,]
MI.integrated.se <- MI.integrated.se[mrsd.common,]
MI.integrated.se <- logNormCounts(MI.integrated.se)
MI.mrsd.pred <- SingleR(test = MI.integrated.se, ref = mrsd.se, method = "single", labels = mrsd.se$label.main)
MI.integrated[["mrsd.main"]] <- DC.mrsd.pred$labels
MI.mrsd.pred <- SingleR(test = MI.integrated.se, ref = mrsd.se, method = "single", labels = mrsd.se$label.fine)
MI.integrated[["mrsd.fine"]] <- DC.mrsd.pred$labels
```

## Filter Endothelial/Fibroblast, double cell type clusteres and other technical noise[<PMID:30471926>] (CL 5, 10, 12, 23, 24, 27, 29, 30)

```{r}
MI.integrated.1st.filtered = subset(MI.integrated, idents = c(0,1,2,3,4,6,7,8,9,11,13,14,15,16,17,18,19,20,21,22,25,26,28,31,32,33))
DefaultAssay(MI.integrated.1st.filtered) <- "integrated"
MI.integrated.1st.filtered <- RunPCA(MI.integrated.1st.filtered, verbose = FALSE)
ElbowPlot(object = MI.integrated.1st.filtered, ndims = 50)
use.pcs = 1:40
MI.integrated.1st.filtered <- RunUMAP(MI.integrated.1st.filtered, reduction = "pca", dims = use.pcs)
MI.integrated.1st.filtered <- FindNeighbors(object = MI.integrated.1st.filtered, reduction = "pca", dims = use.pcs)
MI.integrated.1st.filtered <- FindClusters(object = MI.integrated.1st.filtered, resolution = seq(0.5,2,0.1))
sapply(grep("^integrated_snn_res",colnames(MI.integrated.1st.filtered@meta.data),value = TRUE), function(x) length(unique(MI.integrated.1st.filtered@meta.data[,x])))
DimPlot(object = MI.integrated.1st.filtered, reduction = 'umap', group.by = "integrated_snn_res.1.5", pt.size=1, label = TRUE, repel = TRUE) + NoLegend()
DimPlot(object = MI.integrated.1st.filtered, reduction = 'umap', group.by = "batchid", pt.size=0.5)
DimPlot(object = MI.integrated.1st.filtered, reduction = 'umap', group.by = "orig.ident", split.by = "batchid",  pt.size=0.5, ncol = 3) + NoLegend()
MI.integrated.1st.filtered <- SetIdent(MI.integrated.1st.filtered, value = 'integrated_snn_res.1.5')

```
